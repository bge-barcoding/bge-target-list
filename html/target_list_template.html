<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
  <title>Naturalis Target List</title>
  <link rel="stylesheet" href="./slickgrid/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="./slickgrid/controls/slick.pager.css" type="text/css"/>
  <link rel="stylesheet" href="./slickgrid/css/smoothness/jquery-ui.css" type="text/css"/>
  <link rel="stylesheet" href="./slickgrid/css/examples.css" type="text/css"/>
  <link rel="stylesheet" href="./slickgrid/css/select2.css" type="text/css"/>
  <link rel="stylesheet" href="./slickgrid/css/loader.css" type="text/css"/>
  <link rel="stylesheet" href="./slickgrid/css/jquery.modal.min.css" />
  <link rel="stylesheet" href="./slickgrid/css/jQuery-plugin-progressbar.css" type="text/css"/>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: White;
      overflow: hidden;
    }

    body {
      font: 12px Helvetica, Arial, sans-serif;
    }

    .ui-slider .ui-slider-handle {
      z-index: 1;
    }

    .slick-preheader-panel.ui-state-default  {
      width: 100%;
      overflow: hidden;
      border-left: 0px !important;
      border-bottom: 0px !important;
    }
    .slick-preheader-panel .slick-header-columns {
      border-bottom: 0px !important;
    }

    .slick-cell.selected {
      background-color: beige;
    }

    /*.slick-headerrow-column {
      background: #87ceeb;
      text-overflow: clip;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }*/

    .slick-headerrow-column input {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .slick-cell.green {
      color: green;
    }
    .slick-cell.orange {
      color: orange;
    }
    .slick-cell.red {
      color: red;
    }

    .ui-icon-background,
    .ui-state-active .ui-icon-background {
        border: #003eff/*{borderColorActive}*/;
        background-color: #ffffff/*{fcActive}*/;
    }
    .ui-state-active a,
    .ui-state-active a:link,
    .ui-state-active a:visited {
        color: #ffffff/*{fcActive}*/;
        text-decoration: none;
    }

    .ui-accordion .ui-accordion-content {
      padding: 0.5em 0.5em;
    }

    #loader {
      z-index:10;
      position: absolute;
      top: 120px;
      bottom: 0;
      left:0;
      right:0;
      background: #FEFEFE;
    }

    #loader-panel {
      width:80px;
      height: 80px;
      margin: auto;
      background: #CCC;
      border-radius: 5px;
    }

    .button {
      background: #48387a;
      margin: 10px; cursor: pointer;
      color: white;
      font-weight: bold; width: fit-content;
      padding: 5px 5px 3px 5px; border: 1px solid gray;
      border-radius: 5px;
    }

    .button:hover {
      background: #704b7e;
    }

    .modal {
      z-index: 11;
      background: #FEFEFE;
    }

    .modal a.close-modal {
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>
<div id="ex1" class="modal" style="max-height: 90%; max-width: 90%; width: 90%; overflow-y: auto; overflow-x: hidden; font-size: 16px">
  <p><h1>Target list</h1></p>
  <div style="width: auto;display: flex">
    <div id="about-desc" style="display: flex;width: 800px">
      The ARISE program aims to enable large-scale biomonitoring using, among others, DNA methods. We strive to create
      an infrastructure that enables high-throughput species identification, as well as molecular biodiversity discovery
      and monitoring. With plans to sequence 350,000 specimens, we aim to cover at least 95% of all Dutch species,
      ranging from plants and insects we see around us, to fungi hidden in our soil and the multitude of planktonic
      organisms inhabiting our water. This target list is where we keep track of which species of the Dutch flora and
      fauna have been sequenced for the DNA reference library, both in-house at Naturalis Biodiversity Center and the
      Westerdijk Fungal Biodiversity Institute and at other laboratories around the world. By comparing all that has
      been sequenced to the current list of Dutch species as recorded by Nederlandsesoorten.nl, we can find the gaps
      in our reference database, and create a target list for species to be collected and sequenced with the ARISE program.
    </div>
    <div id="about-completness">
      <div style="text-align: center; border-radius: 15px; height: 160px; width: 140px; margin-left: 15px; background: #48387a">
        <div style="height:40px; text-align:center; font-size: 20px; margin: 0px 0px; font-weight: 600; color: white">Overall Completeness</div>
        <div class="progress-bar position" data-percent="##COMPLNES##" data-duration="500" data-color="#ccc,green"></div>
      </div>
    </div>
  </div>
  <p><h1>Contact Us</h1></p>
  <p>By email: arise[at]naturalis.nl or via Gitlab issue (soon)
  <p><h1>Statistics</h1></p>
  <table>
    <tr><td>Total Barcodes</td><td>##bc##</td></tr>
    <tr><td>Total Specimens</td><td>##sc##</td></tr>
    <tr><td>Total Markers</td><td>##mc##</td></tr>
    <tr><td>Arise Barcodes</td><td>##abc##</td></tr>
    <tr><td>Arise Specimens</td><td>##asc##</td></tr>
    <tr><td>Arise Markers</td><td>##amc##</td></tr>
    <tr><td>&nbsp;</td><td></td></tr>
    <tr><td>NSR species</td><td>##species##</td></tr>
    <tr><td>NSR genus</td><td>##genus##</td></tr>
    <tr><td>NSR family</td><td>##family##</td></tr>
    <tr><td>NSR order</td><td>##order##</td></tr>
    <tr><td>NSR class</td><td>##class##</td></tr>
    <tr><td>NSR phylum</td><td>##phylum##</td></tr>
  </table>


  <p><h1>Frequently Ask Questions</h1></p>
  <p><h3>Which taxonomy backbone are you using?</h3></p>
  The project used the taxonomy provided by the <a href="https://www.nederlandsesoorten.nl/">Dutch Species Register</a>.<br>
  The data are downloaded from the Netherlands Biodiversity API (NBA) :
  <a href="http://api.biodiversitydata.nl/v2/taxon/dwca/getDataSet/nsr">http://api.biodiversitydata.nl/v2/taxon/dwca/getDataSet/nsr</a>.<br>
  Current version: 24/09/22
  <br>
  <p><h3>Which barcodes data are currently inserted?</h3></p>
  Barcodes data originate from two sources:
  <ul style="margin-left: 15px">
    <li>BOLD (Retrieved 28/08/22)</li>
    <li>Arise</li>
    <ul style="margin-left: 15px">
      <li>Naturalis Biodiversity Center (August 2022)</li>
      <li>Westerdijk Fungal Biodiversity Institute (September 2022)</li>
    </ul>
  </ul>
  <p><h3>What information is stored in the <i>locality</i> column?</h3></p>
  The locality column holds the country or list of countries where the specimens have been collected.
  <br>
  <p><h3>How is computed the overall completeness?</h3></p>
  The value displayed is the mean value (average) % barcode coverages (All) of Animalia, Plantae and Fungi Kingdoms.
  <br>
  <p><h1>Latest changes</h1></p>
  <ul style="margin-left: 15px">
    <li>update BOLD with global data</li>
    <li>Add an About page</li>
  </ul>
  <br>
  <p><b>Last update:</b> ##date##<p>
  <p><b>Version:</b> <a href="https://gitlab.com/arise-biodiversity/sequencing/arise-barcode-metadata/-/commit/##githash##">##githash##</a><p>
  <a href="#" rel="modal:close">Close</a>
</div>
<div id="loader">
  <div id="loader-panel">
    <div class="lds-grid"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
    <div style="width:80px; text-align:center">Loading..</div>
  </div>
</div>
<div>
  <div style="background: #48387a; display: flex; align-items: center; justify-content: space-between;">
    <div class="image" style="max-width: 100%; margin-left: 1em; margin-top: 0.5em">
      <img src="inverted_arise_logo.png" style="height: 100px; background: #48387a;"></img>
    </div>
    <div>
      <div id="aboutBut" class="button" style="font-size: 30px">
        <a style="text-decoration: none; color: inherit" href="#ex1" rel="modal:open">About</a>
      </div>
    </div>
  </div>
  <div id="accordion-filter">
    <h3>Filters</h3>
    <div id="filters">
      <b><a href="https://www.nederlandsesoorten.nl/content/statuscodes-voorkomen-nederland" target="_blank">Species occurrence status &#10548;:</a></b>
      <i><span style="color: #991111">Active only in 'species' view</span></i>
      <div style="padding:10px 10px 10px 10px;">
        <label>0 To be assessed
          <input type="checkbox" name="oscb" value="0" id="cb-oc0">
        </label>
        <label>1 Indigenous
          <input type="checkbox" name="oscb" value="1" id="cb-oc1">
        </label>
        <label>2 Exotic
          <input type="checkbox" name="oscb" value="2" id="cb-oc2">
        </label>
        <label>3 Insufficient data
          <input type="checkbox" name="oscb" value="3" id="cb-oc3">
        </label>
        <label>4 Other
          <input type="checkbox" name="oscb" value="4" id="cb-oc4">
        </label>
      </div>
      <b>Barcode coverage:</b>
      <div style="padding:10px 10px 0px 10px;">
        <label style="width:180px;float:left; line-height: 27px;">Cov. % between: </label>
        <div style="padding:3px;">
          <div style="width:150px;display:inline-block;" id="pcSlider"></div>
          <div style="display: inline-block;">
            <input style="width: 45px; margin-left: 10px;" type="number" min="0" max="100" value="0" id="pcSliderI1"/> -
            <input style="width: 45px;" type="number" min="0" max="100" value="100" id="pcSliderI2" />
          </div>
        </div>
      </div>
      <div style="padding:10px 10px 0 10px;">
        <label style="width:180px;float:left;line-height: 27px;">Arise cov. % between: </label>
        <div style="padding:3px;">
          <div style="width:150px;display:inline-block;" id="pcSliderArise"></div>
          <div style="display: inline-block;">
            <input style="width: 45px; margin-left: 10px;" type="number" min="0" max="100" value="0" id="pcSliderAriseI1"/> -
            <input style="width: 45px;" type="number" min="0" max="100" value="100" id="pcSliderAriseI2" />
          </div>
        </div>
      </div>
      <div style="padding:10px 10px 0 10px;">
        <label style="width:180px;float:left;line-height: 27px;">Other cov. % between: </label>
        <div style="padding:3px;">
          <div style="width:150px;display:inline-block;" id="pcSliderOther"></div>
          <div style="display: inline-block;">
            <input style="width: 45px; margin-left: 10px;" type="number" min="0" max="100" value="0" id="pcSliderOtherI1"/> -
            <input style="width: 45px;" type="number" min="0" max="100" value="100" id="pcSliderOtherI2" />
          </div>
        </div>
      </div>
      <br>
      <b>Barcoded specimen locality:</b> <i><span style="color: #991111">Active only in 'species' view</span></i>
      <div style="padding:10px 10px 0 10px;" id="loc-cb-div">
      </div>
      <br>
    </div>
  </div>
  <br>
  <div style="margin-left:1em">
    <b>Group by:</b>
    <div style="padding:0px 0px 10px 10px;">
      <label for="taxonl">Taxon level</label>
      <select name="taxonlist" id="taxonl">
      </select>
    </div>
  </div>
  <div id="exportBut" class="button" onclick="exportTable()">Export Table</div>
  <div class="container">
    <div id="grid"></div>
    <div id="pager" style="width:100%;height:20px;"></div>
  </div>`
</div>


<script src="./slickgrid/lib/firebugx.js"></script>
<script src="./slickgrid/lib/jquery-1.12.4.min.js"></script>
<script src="./slickgrid/lib/jquery-ui.min.js"></script>
<script src="./slickgrid/lib/jquery.event.drag-2.3.0.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<script src="./slickgrid/lib/jQuery-plugin-progressbar.js"></script>

<script src="./slickgrid/slick.core.js"></script>
<script src="./slickgrid/slick.grid.js"></script>
<script src="./slickgrid/slick.dataview.js"></script>
<script src="./slickgrid/slick.formatters.js"></script>
<script src="./slickgrid/plugins/slick.resizer.js"></script>
<script src="./slickgrid/plugins/slick.cellrangedecorator.js"></script>
<script src="./slickgrid/plugins/slick.cellrangeselector.js"></script>
<script src="./slickgrid/plugins/slick.cellexternalcopymanager.js"></script>
<script src="./slickgrid/plugins/slick.cellselectionmodel.js"></script>
<script src="./slickgrid/controls/slick.pager.js"></script>
<script src="./slickgrid/lib/select2.js"></script>

<script>
  var taxonList = {
    kingdom: 'kingdom',
    phylum: 'phylum',
    class: 'class',
    order: 'order',
    family: 'family',
    genus: 'genus',
    species: 'species',
  }

  var index = 0;
  var select = document.getElementById('taxonl');
  for (element in taxonList) {
     var opt = document.createElement("option");
     opt.value = taxonList[element];
     opt.innerHTML = element;
     if (element === 'family') {
       opt.selected = 'selected';
     }
     select.appendChild(opt);
     index++;
  }

  // var localities =  [ "Netherlands", "Belgium", "Germany" ];

  var localities =  "##LOCALITIES##";
  var cbDiv = document.getElementById('loc-cb-div');
  for (loc of localities) {
    var cbId = 'cb-' + loc;
    var input = $('<input type="checkbox">').attr({id: cbId, name: "ocl", value: loc})
    var label = $('<label>').text(loc);
    label.append(input[0]);
    cbDiv.append(label[0]);
  }

  resizer = new Slick.Plugins.Resizer({
        container: '.container', // DOM element selector, can be an ID or a class name

        // optionally define some padding and dimensions
        rightPadding: 5,    // defaults to 0
        bottomPadding: 30,  // defaults to 20
        minHeight: 150,     // defaults to 180
        minWidth: 250,      // defaults to 300

        // you can also add some max values (none by default)
        // maxHeight: 1000
        // maxWidth: 2000
      },
  );
  resizer.pauseResizer(false);
  resizer.resizeGrid();

  function CreateAddlHeaderRow() {
    var $preHeaderPanel = $(grid.getPreHeaderPanel())
        .empty()
        .addClass("slick-header-columns")
        .css('left','-1000px')
        .width(grid.getHeadersWidth());
    $preHeaderPanel.parent().addClass("slick-header");

    var headerColumnWidthDiff = grid.getHeaderColumnWidthDiff();
    var m, header, lastColumnGroup = '', widthTotal = 0;
    
    for (var i = 0; i < columns.length; i++) {
      m = columns[i];
      if (lastColumnGroup === m.columnGroup && i>0) {
        widthTotal += m.width;
        header.width(widthTotal - headerColumnWidthDiff)
      } else {
          widthTotal = m.width;
          header = $("<div class='ui-state-default slick-header-column' />")
            .html("<span class='slick-column-name'>" + (m.columnGroup || '') + "</span>")
            .width(m.width - headerColumnWidthDiff)
            .appendTo($preHeaderPanel);
      }
      lastColumnGroup = m.columnGroup;
    }
  }

  // placeholder for the data array
  var data = "##DATA##";
  var dataView;
  var grid;
  var columns = [
    {id: "kingdom", name: "Kingdom", field: "kingdom", width: 120, columnGroup:"NSR taxonomy", sortable: true},
    {id: "phylum", name: "Phylum", field: "phylum", width: 120, columnGroup:"NSR taxonomy", sortable: true},
    {id: "class", name: "Class", field: "class", width: 120, columnGroup:"NSR taxonomy", sortable: true},
    {id: "order", name: "Order", field: "order", width: 120, columnGroup:"NSR taxonomy", sortable: true},
    {id: "family", name: "Family", field: "family", width: 120, columnGroup:"NSR taxonomy", sortable: true},
    {id: "genus", name: "Genus", field: "genus", width: 120, columnGroup:"NSR taxonomy", sortable: true},
    {id: "species", name: "Species", field: "species", width: 180, columnGroup:"NSR taxonomy", sortable: true},
    {id: "total_sp", name: "Total", exportName: "Total species", field: "total_sp", columnGroup:"Species count", sortable: true},
    {id: "sp_w_bc", name: "With barcodes", exportName: "Species with barcodes", field: "sp_w_bc", columnGroup:"Species count", sortable: true},
    {id: "total_bc", name: "Barcodes", exportName: "Total barcodes", field: "total_bc", columnGroup:"All", sortable: true},
    {id: "coverage", name: "% Coverage", field: "coverage", columnGroup:"All", sortable: true},
    //{id: "coveragef", name: "% cov", field: "coverage", width: 80, resizable: false, formatter: Slick.Formatters.PercentCompleteBar, columnGroup:"All", sortable: true},
    {id: "arise_bc", name: "Barcodes", exportName: "Arise barcodes", field: "arise_bc", columnGroup:"Arise", sortable: true},
    {id: "coverage_arise", name: "% Cov.", exportName: "Arise % Coverage", field: "coverage_arise", columnGroup:"Arise", sortable: true},
    {id: "not_arise_bc", name: "Barcodes", exportName: "Other barcodes", field: "not_arise_bc", columnGroup:"Other", sortable: true},
    {id: "coverage_not_arise", name: "% Cov.", exportName: "Other % Coverage", field: "coverage_not_arise", columnGroup:"Other", sortable: true},
    {id: "locality", name: "Specimen(s) Locality", exportName: "Specimen(s) Locality", field: "locality", sortable: true},
    {id: "occ_status", name: "Species Occ. Status", exportName: "Species Occurrence Status", field: "occ_status", sortable: true},
  ];
  var columnFilters = {};

  var options = {
    enableCellNavigation: true,
    enableColumnReorder: false,
    // enableAutoSizeColumns: true,
    createPreHeaderPanel: true,
    showPreHeaderPanel: true,
    preHeaderPanelHeight: 23,
    showHeaderRow: true,
    headerRowHeight: 30,
    explicitInitialization: true,
    multiColumnSort: true,
    numberedMultiColumnSort: true,
    tristateMultiColumnSort: true
  };

  var pluginOptions = {};


  var sortcol = "kingdom";
  var sortdir = 1;

  var minCoverageThreshold = 0;
  var maxCoverageThreshold = 100;

  $("#pcSliderI1").val(minCoverageThreshold);
  $("#pcSliderI2").val(maxCoverageThreshold);

  var minAriseCoverageThreshold = 0;
  var maxAriseCoverageThreshold = 100;

  $("#pcSliderAriseI1").val(minAriseCoverageThreshold);
  $("#pcSliderAriseI2").val(maxAriseCoverageThreshold);

  var minOtherCoverageThreshold = 0;
  var maxOtherCoverageThreshold = 100;

  $("#pcSliderOtherI1").val(minOtherCoverageThreshold);
  $("#pcSliderOtherI2").val(maxOtherCoverageThreshold);

  var groupBy = 'family'
  var h_runfilters = null;

  function myFilter(item, args) {
    if (args.groupBy && item["rank"] !== args.groupBy) {
      return false;
    }

    if (item["coverage"] < args.minCoverageThreshold || item["coverage"] > maxCoverageThreshold) {
      return false;
    }

    if (item["coverage_arise"] < args.minAriseCoverageThreshold || item["coverage_arise"] > maxAriseCoverageThreshold) {
      return false;
    }

    if (item["coverage_not_arise"] < args.minOtherCoverageThreshold || item["coverage_not_arise"] > maxOtherCoverageThreshold) {
      return false;
    }

    for (var columnId in columnFilters) {
      if (columnId !== undefined && columnFilters[columnId] !== "") {
        var c = grid.getColumns()[grid.getColumnIndex(columnId)];
        if (!item[c.field] || item[c.field].toLowerCase().indexOf(columnFilters[columnId].toLowerCase()) === -1) {
          return false;
        }
      }
    }

    if (args.groupBy == "species") {
      var osaLen = args.occurrenceStatus.length;
      if (osaLen !== 0) {
        if (item["occ_status"] === "") {
          return false;
        }
        var i = 0, filterEntry = true;
        while (i < osaLen) {
            if (args.occurrenceStatus[i] === item["occ_status"][0]) {
              filterEntry = false;
              break;
            }
            i++;
        }
        if (filterEntry) {
          // console.log(args.occurrenceStatus);
          // console.log(item["occ_status"]);
          return false;
        }
      }

      var laLen = args.locality.length;
      if (laLen !== 0) {
        if (["Unknown", ""].includes(item["locality"])) {
          return false;
        }
        var i = 0, filterEntry = true;
        while (i < laLen) {
            if (item["locality"].indexOf(args.locality[i]) !== -1) {
              filterEntry = false;
              break;
            }
            i++;
        }
        if (filterEntry)  {
          // console.log(args.locality);
          // console.log(item["locality"]);
          return false;
        }
      }
    }

    return true;
  }


  function formatToTSV(obj) {
    const header = columns.map(e => 'exportName' in e ? e.exportName : e.name).join('\t');
    const tsvContent = obj.map((e) => {
      const rowData = [];
      Object.entries(e).forEach((entry) => {
        const key = entry[0];
        const value = entry[1];
        if (key !== 'id' && key !== 'rank') {
          rowData.push(value);
        }
      });
      return rowData.join('\t');
    }).join('\n');
    return `${header}\n${tsvContent}`;
  }

  function exportTable(){
    var filename = `arise_targetlist_${Date.now()}.tsv`
    var blob = new Blob([formatToTSV(dataView.getFilteredItems())], {type: "application/json;charset=utf-8"});
    var url = URL.createObjectURL(blob);
    var elem = document.createElement("a");
    elem.href = url;
    elem.download = filename;
    document.body.appendChild(elem);
    elem.click();
    document.body.removeChild(elem);
  }

  // function coverageSort(a, b) {
  //   console.log(a);
  //   return a["coverage"] - b["coverage"];
  // }

  // function comparer(a, b) {
  //   var x = a[sortcol], y = b[sortcol];
  //   return (x == y ? 0 : (x > y ? 1 : -1));
  // }

  $(function() {
    $(".progress-bar").loading();
    $( "#accordion-filter" ).accordion({
      collapsible: true,
      activate: function(event, ui) { resizer.resizeGrid(); }
    });
    $("input:checkbox").checkboxradio();
    $("#loader").hide();

    dataView = new Slick.Data.DataView({ inlineFilters: true });
    grid = new Slick.Grid("#grid", dataView, columns, options);
    var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));
    grid.registerPlugin(resizer);
    grid.setSelectionModel(new Slick.CellSelectionModel());
    grid.registerPlugin(new Slick.CellExternalCopyManager(pluginOptions));

    grid.onBeforeSort.subscribe(function (e, args) {
      return true;
    });

    grid.onSort.subscribe(function (e, args) {
      sortdir = args.sortAsc ? 1 : -1;
      const sortColumns = (args.multiColumnSort) ? args.sortCols : new Array({sortAsc: args.sortAsc, sortCol: args.sortCol});

      // using native sort with comparer
      // dataView.sort(comparer, args.sortAsc);
      dataView.sort(function (dataRow1, dataRow2) {
        for (var i = 0, l = sortColumns.length; i < l; i++) {
          var field = sortColumns[i].sortCol.field;

          var sign = sortColumns[i].sortAsc ? 1 : -1;
          var value1 = dataRow1[field], value2 = dataRow2[field];
          var result = (value1 == value2 ? 0 : (value1 > value2 ? 1 : -1)) * sign;
          if (result != 0) {
            return result;
          }
        }
        return 0;
      });

    });

    grid.onBeforeAppendCell.subscribe(function (e, args) {
      if (grid.getColumns()[args.cell].id.indexOf('coverage') === -1) return null;
  
      if (args.value == null || args.value === "") {
        return null;
      } else if (args.value < 33.333) {
        return "red";
      } else if (args.value < 66.666) {
        return "orange";
      }
      return "green";
    });


    dataView.onRowCountChanged.subscribe(function (e, args) {
      grid.updateRowCount();
      grid.render();
    });

    dataView.onRowsChanged.subscribe(function (e, args) {
      grid.invalidateRows(args.rows);
      grid.render();
    });

    var h_runfilters = null;

    // wire up the slider to apply the filter to the model
    $("#pcSlider").slider({
      range: true,
      min: 0,
      max: 100,
      values: [ 0, 100 ],
      slide: function (event, ui) {
        if (minCoverageThreshold != ui.values[0] || maxCoverageThreshold != ui.values[1]) {
          window.clearTimeout(h_runfilters);
          h_runfilters = window.setTimeout(updateFilter, 10);
          minCoverageThreshold = ui.values[0];
          maxCoverageThreshold = ui.values[1];
          $("#pcSliderI1").val(ui.values[0]);
          $("#pcSliderI2").val(ui.values[1]);
        }
      }
    });

    $("#pcSliderI1").change(function () {
      var v = Math.max($(this).val(), 0);
      v = Math.min($(this).val(), 100);
      if (v > $("#pcSliderI2").val()) {
        v = $("#pcSliderI2").val()
      }
      $("#pcSlider").slider("option", "values", [v, $("#pcSliderI2").val()]);
      $("#pcSlider").data("ui-slider")._slide();
    });

    $("#pcSliderI2").change(function () {
      var v = Math.max($(this).val(), 0);
      v = Math.min($(this).val(), 100);
      if (v < $("#pcSliderI1").val()) {
        v = $("#pcSliderI1").val()
      }
      $("#pcSlider").slider("option", "values", [$("#pcSliderI1").val(), v]);
      $("#pcSlider").data("ui-slider")._slide();
    });

    // wire up the slider to apply the filter to the model
    $("#pcSliderArise").slider({
      range: true,
      min: 0,
      max: 100,
      values: [ 0, 100 ],
      slide: function (event, ui) {
        if (minAriseCoverageThreshold != ui.values[0] || maxAriseCoverageThreshold != ui.values[1]) {
          window.clearTimeout(h_runfilters);
          h_runfilters = window.setTimeout(updateFilter, 10);
          minAriseCoverageThreshold = ui.values[0];
          maxAriseCoverageThreshold = ui.values[1];
          $("#pcSliderAriseI1").val(ui.values[0]);
          $("#pcSliderAriseI2").val(ui.values[1]);
        }
      }
    });

    $("#pcSliderAriseI1").change(function () {
      var v = Math.max($(this).val(), 0);
      v = Math.min($(this).val(), 100);
      if (v > $("#pcSliderAriseI2").val()) {
        v = $("#pcSliderAriseI2").val()
      }
      $("#pcSliderArise").slider("option", "values", [v, $("#pcSliderAriseI2").val()]);
      $("#pcSliderArise").data("ui-slider")._slide();
    });

    $("#pcSliderAriseI2").change(function () {
      var v = Math.max($(this).val(), 0);
      v = Math.min($(this).val(), 100);
      if (v < $("#pcSliderAriseI1").val()) {
        v = $("#pcSliderAriseI1").val()
      }
      $(this).val(v);
      $("#pcSliderArise").slider("option", "values", [$("#pcSliderAriseI1").val(), v]);
      $("#pcSliderArise").data("ui-slider")._slide();
    });

        // wire up the slider to apply the filter to the model
    $("#pcSliderOther").slider({
      range: true,
      min: 0,
      max: 100,
      values: [ 0, 100 ],
      slide: function (event, ui) {
        if (minOtherCoverageThreshold != ui.values[0] || maxOtherCoverageThreshold != ui.values[1]) {
          window.clearTimeout(h_runfilters);
          h_runfilters = window.setTimeout(updateFilter, 10);
          minOtherCoverageThreshold = ui.values[0];
          maxOtherCoverageThreshold = ui.values[1];
          $("#pcSliderOtherI1").val(ui.values[0]);
          $("#pcSliderOtherI2").val(ui.values[1]);
        }
      }
    });

    $("#pcSliderOtherI1").change(function () {
      var v = Math.max($(this).val(), 0);
      v = Math.min($(this).val(), 100);
      if (v > $("#pcSliderOtherI2").val()) {
        v = $("#pcSliderOtherI2").val()
      }
      $("#pcSliderOther").slider("option", "values", [v, $("#pcSliderOtherI2").val()]);
      $("#pcSliderOther").data("ui-slider")._slide();
    });

    $("#pcSliderOtherI2").change(function () {
      var v = Math.max($(this).val(), 0);
      v = Math.min($(this).val(), 100);
      if (v < $("#pcSliderOtherI1").val()) {
        v = $("#pcSliderOtherI1").val()
      }
      $("#pcSliderOther").slider("option", "values", [$("#pcSliderOtherI1").val(), v]);
      $("#pcSliderOther").data("ui-slider")._slide();
    });

    $('select[name="taxonlist"]').change(function(){
        if (groupBy !== $(this).val()) {
          window.clearTimeout(h_runfilters);
          h_runfilters = window.setTimeout(updateFilter, 10);
          groupBy = $(this).val();
        }
    });

    $('input[type="checkbox"]').click(function() {
        h_runfilters = window.setTimeout(updateFilter, 10);
    });


    function updateFilter() {
      dataView.setFilterArgs({
        groupBy: groupBy,
        minCoverageThreshold: minCoverageThreshold,
        maxCoverageThreshold: maxCoverageThreshold,
        minAriseCoverageThreshold: minAriseCoverageThreshold,
        maxAriseCoverageThreshold: maxAriseCoverageThreshold,
        minOtherCoverageThreshold: minOtherCoverageThreshold,
        maxOtherCoverageThreshold: maxOtherCoverageThreshold,
        occurrenceStatus: $("input[name='oscb']:checked").map(function(){return $(this).val();}).get(),
        locality: $("input[name='ocl']:checked").map(function(){return $(this).val();}).get()
      });
      dataView.refresh();
    }


    $(grid.getHeaderRow()).on("change keyup", ":input", function (e) {
      var columnId = $(this).data("columnId");
      if (columnId != null) {
        columnFilters[columnId] = $.trim($(this).val());
        dataView.refresh();
      }
    });

    grid.onHeaderRowCellRendered.subscribe(function(e, args) {
        $(args.node).empty();
        if (!['kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species', 'occ_status', 'locality'].includes(args.column.id)) {
          return;
        }
        $("<input type='text' placeholder='Filter'>")
           .data("columnId", args.column.id)
           .val(columnFilters[args.column.id])
           .appendTo(args.node);
    });

    grid.init();

    grid.onColumnsResized.subscribe(function (e, args) {
      CreateAddlHeaderRow();
    });
    
    CreateAddlHeaderRow();
    
    // Initialise data
    dataView.beginUpdate();
    dataView.setItems(data);
    dataView.setFilter(myFilter);
    dataView.setFilterArgs({
      groupBy: groupBy,
        minCoverageThreshold: minCoverageThreshold,
        maxCoverageThreshold: maxCoverageThreshold,
        minAriseCoverageThreshold: minAriseCoverageThreshold,
        maxAriseCoverageThreshold: maxAriseCoverageThreshold,
        minOtherCoverageThreshold: minOtherCoverageThreshold,
        maxOtherCoverageThreshold: maxOtherCoverageThreshold,
    });
    dataView.endUpdate();
  })
</script>
</body>
</html>

